## 1. 概述

Instancio创建的对象的属性可以使用以下方法进行自定义：

+ generate()
+ set()
+ supply()

[InstancioApi](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/InstancioApi.html)类中定义了这些方法。

## 2. 使用generate()

generate()
方法提供对JDK中核心类型的内置生成器的访问，例如字符串、数值类型、日期、数组、集合等，它允许修改这些类型的生成参数以微调数据。下面的示例显示了用法，其中gen参数(
类型为[Generators](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/generators/Generators.html))
公开了可用的生成器，以使用IDE自动完成来简化它们的发现。

```java
// Example of using generate()
Person person = Instancio.of(Person.class)
    .generate(field("age"), gen -> gen.ints().range(18, 65))
    .generate(field("pets"), gen -> gen.array().length(3))
    .generate(field(Phone.class, "number"), gen -> gen.text().pattern("#d#d#d-#d#d-#d#d"))
    .create();
```

下面是自定义Person的另一个示例. 例如，如果该Person类有一个字段List<
Phone\>，则默认情况下Instancio将使用ArrayList作为实现。使用集合生成器，可以通过显式指定类型来覆盖它：

```java
// Example: customising a collection
Person person = Instancio.of(Person.class)
    .generate(field("phoneNumbers"), gen -> gen.collection().minSize(3).subtype(LinkedList.class))
    .generate(field(Phone.class, "countryCode"), gen -> gen.oneOf("+33", "+39", "+44", "+49"))
    .create();
```

每个生成器都提供适用于它生成的类型的方法，例如：

+ gen.string().minLength(3).allowEmpty().nullable()
+ gen.map().size(5).nullableValues().subtype(TreeMap.class)
+ gen.temporal().localDate().future()
+ gen.longs().min(Long.MIN_VALUE)
+ gen.enumOf(MyEnum.class).excluding(MyEnum.FOO, MyEnum.BAR)

此外，大多数生成器还可以将生成的值作为字符串返回，例如：

```java
class Foo {
    String dateString;
    String enumString;
}

Instancio.of(Foo.class)
    .generate(field("dateString"), gen -> gen.temporal().localDate().past().asString())
    .generate(field("enumString"), gen -> gen.enumOf(MyEnum.class).asString(e -> e.name().toUpperCase()))
    .create();
```

内置生成器的完整列表：

```java
Generators
│
├── booleans()
├── chars()
├── bytes()
├── shorts()
├── ints()
├── longs()
├── floats()
├── doubles()
├── string()
│
├── array()
├── collection()
├── map()
├── enumOf(Class<E>)
├── enumSet(Class<E>)
│
├── oneOf(Collection<T>)
├── oneOf(T...)
│
├── math()
│   └── bigInteger()
│   └── bigDecimal()
│
├── net()
│   └── uri()
│   └── url()
│
├── io()
│   └── file()
│
├── nio()
│   └── path()
│
├── atomic()
│   ├── atomicInteger()
│   └── atomicLong()
│
├── temporal()
│   └── calendar()
│   └── date()
│   └── duration()
│   └── instant()
│   └── localDate()
│   └── localDateTime()
│   └── localTime()
│   └── offsetDateTime()
│   └── offsetTime()
│   └── period()
│   └── sqlDate()
│   └── timestamp()
│   └── year()
│   └── yearMonth()
│   └── zonedDateTime()
│
└── text()
    └── loremIpsum()
    └── pattern(String)
    └── uuid()
```

## 3. 使用set()

set()方法可用于为选定的目标设置静态值，就像常规的setter方法一样：

```java
Person person = Instancio.of(Person.class)
    .set(field(Phone::getCountryCode), "+1")
    .set(all(LocalDateTime.class), LocalDateTime.now())
    .create();
```

但是，与只能在单个对象上调用的常规setter方法不同，上面的方法将在所有生成的类实例上设置countryCode为“+1”。假设Person类包含一个List<
Phone\>，它们都将具有指定的countryCode。同样，所有LocalDateTime值都将设置为now()的同一实例。

## 4. 使用supply()

supply()方法有两种变体：

```java
supply(TargetSelector selector, Supplier<V> supplier)
supply(TargetSelector selector, Generator<V> generator)
```

第一个接收java.util.function.Supplier并用于提供非随机值。第二个接收Instancio [Generator](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/generator/Generator.html)(
函数式接口)并可用于提供随机值。

### 4.1 使用supply()提供非随机值

以下是将所有LocalDateTime实例设置为now()的另一个示例：

```java
Person person = Instancio.of(Person.class)
    .supply(all(LocalDateTime.class), () -> LocalDateTime.now())
    .create();
```

与前面使用set()的示例不同，这将为每个LocalDateTime分配一个新实例：

```java
set(all(LocalDateTime.class), LocalDateTime.now())        // reuse the same instance for all dates
supply(all(LocalDatime.class), () -> LocalDateTime.now()) // create a new instance for each date
```

### 4.2 使用supply()提供随机值

supply()
方法的第二个变体可用于提供随机值和对象。此方法将[Generator](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/generator/Generator.html)
作为参数，它是具有以下签名的函数式接口：

```java
import org.instancio.Random;

interface Generator<T> {
    T generate(Random random);
}
```

使用提供的[Random](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/Random.html)
实例可确保生成的对象是可重现的。由于Generator是函数式接口，因此可以将其指定为Lambda表达式：

```java
Person person = Instancio.of(Person.class)
        .supply(all(Phone.class), random -> Phone.builder()
                .countryCode(random.oneOf("+1", "+52"))
                .number(random.digits(7))
                .build())
        .create();
```

生成器可用于生成简单的值类型以及构建复杂的对象，[自定义生成器](https://www.instancio.org/user-guide/#custom-generators)
部分对它们进行了更详细的描述。

## 5. 使用onComplete()

自定义生成数据的另一种选择是使用[OnCompleteCallback](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/OnCompleteCallback.html)
，这是一个具有以下签名的函数式接口：

```java
interface OnCompleteCallback<T> {
    void onComplete(T object);
}
```

在完全填充生成的对象后调用OnCompleteCallback，回调只能在对象上调用：

+ 由引擎内部创建
+
由自定义生成器创建或通过[GeneratorProvider](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/spi/GeneratorProvider.html)
supply(TargetSelector, Generator)注册的生成器
+ 由内部生成器使用generate(TargetSelector, Function)创建

永远不会在使用以下方式提供的对象上调用回调：

+ supply(TargetSelector, Supplier)
+ set(TargetSelector, Object)

以下示例演示了如何使用回调修改Address。如果Person具有List<Address\>，将为生成的Address类的每个实例调用回调。

```java
// Example: modifying an object via a callback
Person person = Instancio.of(Person.class)
    .onComplete(all(Address.class), (Address address) -> {
        address.setCity("Vancouver");
        address.setProvince("BC");
        address.setCountry("Canada");
    })
    .create();
```

如果对象是可变的，则回调允许一次修改多个字段。但是，回调不能用于不可变类型。

回调的另一个属性是它们仅在非空对象上调用。在以下示例中，所有Address实例都可以为空。因此，生成的Address实例可以是null或完全填充的对象。但是，如果生成的是null，则不会调用回调。

```java
// Callbacks only called on non-null values
Person person = Instancio.of(Person.class)
    .withNullable(all(Address.class))
    .onComplete(all(Address.class), (Address address) -> {
        // only-called if generated address is not null
    })
    .create();
```

## 6. 自定义对象的方法总结

方法set(TargetSelector, Object)和supply(TargetSelector, Supplier)用于按原样提供对象。提供的对象被引擎视为只读，这些方法的行为无法自定义。

+ 匹配的选择器将不会被应用
+ 引擎不会修改或填充所提供对象的任何字段
+ 不会在这些方法提供的对象上调用回调

方法supply(TargetSelector, Generator)
用于使用自定义Generator实现创建对象，此方法通过AfterGenerate提示提供可配置的行为。默认情况下，提示设置为POPULATE_NULLS_AND_DEFAULT_PRIMITIVES，这意味着：

+ 将应用匹配的选择器
+ 引擎将填充null字段和包含默认值的原始类型字段

AfterGenerate可以使用instancio.properties和[Settings](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/settings/Settings.html)
覆盖提示的默认值。

> 注意：回调总是在生成器创建的对象上调用，无论AfterGenerate值如何。

方法generate(TargetSelector, Function)用于自定义由内部生成器创建的对象，这些对象包括值类型(数字、字符串、日期)和数据结构(
集合、数组)。

+ 始终应用匹配的选择器
+ 始终调用匹配的回调

默认情况下，引擎生成非空值，除非另有说明。

## 7. 忽略字段或类

默认情况下，Instancio将尝试填充每个非静态字段值，可以使用ignore方法忽略在这种情况下不希望的字段：

```java
// Example: ignoring certain fields and classes
Person person = Instancio.of(Person.class)
    .ignore(field(Person::getPets))
    .ignore(all(LocalDateTime.class))
    .create();

// Or combining the selectors
Person person = Instancio.of(Person.class)
    .ignore(all(
        field(Person::getPets),
        all(LocalDateTime.class)))
    .create();
```

ignore()方法比其他方法具有更高的优先级。例如，在下面的代码片段中，指定ignore(all(LocalDateTime.class))
但为lastModified字段提供值实际上会生成具有null值的lastModified。

```java
// ignore() has higher precedence than other methods
Person person = Instancio.of(Person.class)
    .ignore(all(LocalDateTime.class))
    .supply(field(Person::getLastModified), () -> LocalDateTime.now())
    .create();
```

## 8. 可空值

默认情况下，Instancio为所有字段生成非空值。在某些情况下，可能需要放宽此行为，例如验证一段代码在某些null值存在的情况下不会失败。有几种方法可以指定值可以为空，这可以使用以下方法完成：

+ 构建器API的withNullable方法
+ 生成器方法(如果生成器支持的话)
+ [Settings](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/settings/Settings.html)

要使用构建器API指定某些内容可为空，可以按如下方式完成：

```java
// Example: specifying nullability using the builder API
Person person = Instancio.of(Person.class)
    .withNullable(field(Person::getAddress))
    .withNullable(allStrings())
    .create();
```

一些内置生成器还支持将值标记为可为空。此外，Collection、Map和Array生成器允许指定元素、键或值是否可为空。

```java
// Example: specifying nullability using the collection generator
1. Person person = Instancio.of(Person.class)
2.     .generate(field("phoneNumbers"), gen -> gen.collection()
3.             .nullable()
4.             .nullableElements())
5.     .create();
```

+ 3: 集合本身可以为空。
+ 4: 集合元素可以为空。

假设Person类包含一个Map，则可以为键和值指定可为空性：

```java
// Example: specifying nullability using the map generator
Person person = Instancio.of(Person.class)
    .generate(all(Map.class), gen -> gen.map().nullableKeys().nullableValues())
    .create();
```

最后，可以使用[Settings](https://javadoc.io/doc/org.instancio/instancio-core/latest/org/instancio/settings/Settings.html)
指定可空性，但仅适用于核心类型，例如字符串和数字：

```java
// Example: specifying nullability using Settings
Settings settings = Settings.create()
    .set(Keys.STRING_NULLABLE, true)
    .set(Keys.INTEGER_NULLABLE, true)
    .set(Keys.COLLECTION_NULLABLE, true)
    .set(Keys.COLLECTION_ELEMENTS_NULLABLE, true);

Person person = Instancio.of(Person.class)
    .withSettings(settings)
    .create();
```